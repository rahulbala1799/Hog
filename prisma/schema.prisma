// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  STAFF
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum BookingType {
  REGULAR
  GIFTS
  INFLUENCER
}

enum SessionTime {
  SESSION_1  // 7:00 PM - 8:00 PM
  SESSION_2  // 9:00 PM - 10:00 PM
}


enum Currency {
  INR
  USD
  EUR
  GBP
}

model User {
  id        String    @id @default(uuid())
  email     String    @unique
  password  String
  name      String
  role      Role
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Better Auth relations (unused but kept for backward compatibility)
  accounts  Account[]
  sessions  Session[]
  
  // Business relations
  bookings              Booking[]
  expenses              Expense[]
  inventoryItems        InventoryItem[]    @relation("InventoryCreatedBy")
  inventoryLogs         InventoryLog[]     @relation("InventoryLogPerformedBy")

  @@map("users")
}

model ClassType {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  duration    Int       // in minutes
  price       Float
  color       String    @default("#8B5CF6") // hex color for calendar
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("class_types")
}

model Booking {
  id             String        @id @default(uuid())
  issueNumber    String        @unique // Format: HOG-XX-YY (e.g., HOG-26-001)
  studentName    String
  studentEmail   String?
  studentPhone   String?
  numberOfPeople Int           @default(1) // PAX count
  sessionDate    DateTime      // Date of the session
  sessionTime    SessionTime   // SESSION_1 or SESSION_2
  bookingType    BookingType   @default(REGULAR)
  totalAmountPaid Float?        // Total amount paid (optional)
  status         BookingStatus @default(PENDING)
  notes          String?
  createdBy      User          @relation(fields: [createdById], references: [id], onDelete: Restrict)
  createdById    String
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  
  inventoryLogs  InventoryLog[] // Track inventory consumed by this booking

  @@index([sessionDate])
  @@index([sessionDate, sessionTime])
  @@index([status])
  @@index([issueNumber])
  @@map("bookings")
}

model ExpenseCategory {
  id        String    @id @default(uuid())
  name      String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  expenses  Expense[]

  @@map("expense_categories")
}

model InventoryItem {
  id              String                 @id @default(uuid())
  name            String
  description     String?
  currentStock    Float                  // Changed to Float for fractional units (e.g., 42ml)
  currentCost     Float                  // Current cost per unit
  reorderLevel    Int?                   // Minimum stock level before reordering
  unit            String                 @default("unit") // e.g., "piece", "kg", "liter", "ml"
  createdBy       User                   @relation("InventoryCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  createdById     String
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  
  priceHistory    InventoryPriceHistory[]
  logs            InventoryLog[]
  costOfSaleItems CostOfSaleItem[]

  @@index([name])
  @@map("inventory_items")
}

model InventoryPriceHistory {
  id          String        @id @default(uuid())
  item        InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  itemId      String
  oldPrice    Float?        // Null for initial price
  newPrice    Float
  effectiveDate DateTime    @default(now()) // When this price becomes effective
  changedBy   String        // User email/name
  reason      String?       // Optional reason for price change
  createdAt   DateTime      @default(now())

  @@index([itemId, effectiveDate])
  @@map("inventory_price_history")
}

model InventoryLog {
  id          String        @id @default(uuid())
  item        InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  itemId      String
  action      InventoryAction
  oldValue    String?       // JSON string of old values
  newValue    String?       // JSON string of new values
  quantity    Float?        // For stock adjustments (changed to Float)
  notes       String?
  performedBy User          @relation("InventoryLogPerformedBy", fields: [performedById], references: [id], onDelete: Restrict)
  performedById String
  booking     Booking?      @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  bookingId   String?       // Reference to booking that caused this log
  createdAt   DateTime      @default(now())

  @@index([itemId, createdAt])
  @@index([action])
  @@index([bookingId])
  @@map("inventory_logs")
}

enum InventoryAction {
  CREATED
  STOCK_ADJUSTED
  PRICE_CHANGED
  UPDATED
  DELETED
  AUTO_CONSUMED  // Automatically consumed by booking
}

model CostOfSaleItem {
  id                String        @id @default(uuid())
  item              InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  itemId            String
  quantityPerPerson Float         // Amount consumed per person in a booking
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@unique([itemId]) // Each inventory item can only be configured once
  @@map("cost_of_sale_items")
}

model Expense {
  id          String           @id @default(uuid())
  description String
  amount      Float
  category    ExpenseCategory  @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  categoryId  String
  date        DateTime         @default(now())
  receiptUrl  String?          // Vercel Blob URL for uploaded receipt
  notes       String?
  createdBy   User             @relation(fields: [createdById], references: [id], onDelete: Restrict)
  createdById String
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([date])
  @@index([categoryId])
  @@index([createdById])
  @@map("expenses")
}

model AppSettings {
  id                String    @id @default("singleton") // Only one settings record
  currency          Currency  @default(INR)
  maxPersonsPerClass Int      @default(10)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  classTimings      ClassTiming[]

  @@map("app_settings")
}

model ClassTiming {
  id            String      @id @default(uuid())
  dayOfWeek     Int         // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
  startTime     String      // Format: "HH:MM" (e.g., "09:00")
  endTime       String      // Format: "HH:MM" (e.g., "17:00")
  settings      AppSettings @relation(fields: [settingsId], references: [id], onDelete: Cascade)
  settingsId    String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([settingsId, dayOfWeek])
  @@map("class_timings")
}

// Better Auth required models
model Account {
  id                String  @id @default(uuid())
  userId            String
  accountId         String
  providerId        String
  accessToken       String?
  refreshToken      String?
  idToken           String?
  expiresAt         DateTime?
  password          String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@map("account")
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  expiresAt DateTime
  token     String   @unique
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Verification {
  id         String   @id @default(uuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, value])
  @@map("verification")
}
